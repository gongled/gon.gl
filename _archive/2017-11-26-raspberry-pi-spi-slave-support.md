---
title: Поддержка ведомых устройств в шине SPI Raspberry Pi
updated: 2017-11-26
---

На днях решил научиться собирать метрики с отечественного монитора
качества воздуха [MasterKit MT8060](https://masterkit.ru/shop/others/dadget/1921398), чтобы посчитать оптимальную частоту проветривания помещений в офисе. До этого мой опыт работы ограничивался
лабораторными работами в университете, потому решил собрать первый прототип
на [Raspberry Pi 1 model B](https://www.raspberrypi.org/products/raspberry-pi-1-model-b/) со знакомым
окружением Linux Raspbian.

В Raspberry Pi работают с шиной SPI несколькими способами:

- [Библиотека WiringPi](http://wiringpi.com/) для прямой работы с регистрами.
- [Библиотека на C](http://www.airspayce.com/mikem/bcm2835/) для управления GPIO чипа BCM2835.
- [Драйвер ядра Linux](https://www.kernel.org/doc/html/v4.11/driver-api/spi.html) с доступом к шине через символьное устройство `/dev/spidevX.Y`.

Третий способ удобнее, если вы пишете программу на языке отличном от C. Например, библиотека [spidev](https://pypi.python.org/pypi/spidev), [periph](https://periph.io) и [gobot](https://gobot.io/) используют его для чтения и записи SPI.

В ходе исследования пришёл к неутешительному выводу, что реализовать задуманное будет непросто. Причиной тому [отсутствие поддержки SPI slave](https://github.com/raspberrypi/linux/blob/rpi-3.6.y/drivers/spi/spi-bcm2708.c) в ядре Linux для Broadcom BCM2835, позволяющей хосту выступать в роли ведомого.

[Этим вопросом](https://www.raspberrypi.org/forums/viewtopic.php?p=810290#p810290) задавались и другие пользователи чипа в 2015 году. Предположу, что если вопрос с поддержкой не был решён за три года, то прождать можно ещё долго. Моих же умений недостаточно для разработки своего модуля ядра или изменения кода существующего.

Возможно реализовать протокол в пространстве пользователя и управлять GPIO вручную.
К сожалению, такой подход будет неэффективным из-за высокого потребления CPU от
постоянного поллинга сигнала на пинах.

Ещё можно воспользоваться наработками Тайлера Никольса по использованию [SPI в Raspberry Pi без Linux](https://github.com/matthiasbock/Raspberry-Pi-SPI-slave/wiki). Однако решение кажется излишне расточительным для чтения трёх метрик в секунду.

Выходит, практичнее приобрести микроконтроллер на Arduino и запрограммировать его. Или, если вы ещё выбираете датчик, возьмите [MasterKit 8057S](https://masterkit.ru/shop/others/dadget/2122569) с поддержкой вывода метрик по USB. Для него даже есть [пример приложения под Linux](https://github.com/dmage/co2mon).
